name: Build Mender Artifact and Trigger Deployment

on:
  push:
    branches: [ main, production ]
  pull_request:

env:
  MENDER_ARTIFACTS_CI_ARTIFACT_NAME: mender-artifacts
  MENDER_ARTIFACTS_CI_ARTIFACT_PATH: mender-artifacts
  MENDER_DEPLOYMENT_DEVICES_GROUP_DEV: grp-1
  MENDER_DEPLOYMENT_DEVICES_GROUP_PROD: grp-2
  MENDER_SERVER_URL: https://hosted.mender.io

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: mendersoftware/mender-ci-tools:men-5906_build_and_publish_mender-ci-tools_image_e018e952a4e9a71c318bf2a56651293efff5d8b5
    outputs:
      mender_release_name: ${{ steps.release_name.outputs.mender_release_name }}
      mender_devices_group: ${{ steps.deployment_group.outputs.mender_devices_group }}
      mender_deployment_name: ${{ steps.deployment_name.outputs.mender_deployment_name }}
      mender_artifact_name: ${{ steps.create_artifact.outputs.mender_artifact_name }}
    steps:
      - uses: actions/checkout@v2
      - name: Generrate Mender Release Name
        id: release_name
        run: |
          [ ! -d ${MENDER_ARTIFACTS_CI_ARTIFACT_PATH} ] && mkdir -p ${MENDER_ARTIFACTS_CI_ARTIFACT_PATH}
          APP_NAME=change-the-world-to-better
          VERSION="$(($RANDOM%9+1)).$(($RANDOM%9+1)).$(($RANDOM%9+1))"
          MENDER_RELEASE_NAME=${APP_NAME}_v${VERSION}
          echo "MENDER_RELEASE_NAME=${MENDER_RELEASE_NAME}" >> ${GITHUB_ENV}
          echo "mender_release_name=${MENDER_RELEASE_NAME}" >> ${GITHUB_OUTPUT}
      - name: Choose Mender Deployment Group
        id: deployment_group
        if: ${{ github.event.pull_request.merged }}
        run: |
          if [[ "${GITHUB_BASE_REF}" == "production" ]]; then
            MENDER_DEPLOYMENT_DEVICES_GROUP=${MENDER_DEPLOYMENT_DEVICES_GROUP_PROD}
          elif [[ "${GITHUB_BASE_REF}" == "main" ]]; then
            MENDER_DEPLOYMENT_DEVICES_GROUP=${MENDER_DEPLOYMENT_DEVICES_GROUP_DEV}
          else
            echo "ERROR: workflow execution on not supported branch"
            exit 1
          fi
          echo "mender_devices_group=${MENDER_DEPLOYMENT_DEVICES_GROUP}" >> ${GITHUB_OUTPUT}
      - name: Generate Mender Deployment Name
        id: deployment_name
        run: |
          COMMIT_SHORT_SHA="${GITHUB_SHA:0:8}"
          MENDER_DEPLOYMENT_NAME=${MENDER_RELEASE_NAME}_${COMMIT_SHORT_SHA}
          echo "mender_deployment_name=${MENDER_DEPLOYMENT_NAME}" >> ${GITHUB_OUTPUT}
      - name: Create Mender Artifact
        id: create_artifact
        run: |
          MENDER_ARTIFACT_NAME=artifact_$(( $RANDOM % 9999 + 1000 )).mender
          echo /home/root/.ssh > dest_dir
          echo authorized_keys > filename
          echo key > authorized_keys
          mender-artifact write module-image \
            -T single-file \
            --device-type raspberrypi4 \
            -o ${MENDER_ARTIFACTS_CI_ARTIFACT_PATH}/${MENDER_ARTIFACT_NAME} \
            -n ${MENDER_RELEASE_NAME} \
            --software-name authorized_keys \
            --software-version 1.0 \
            -f dest_dir \
            -f filename \
            -f authorized_keys
          echo "mender_artifact_name=${MENDER_ARTIFACT_NAME}" >> ${GITHUB_OUTPUT}
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.MENDER_ARTIFACTS_CI_ARTIFACT_NAME }}
          path: ${{ env.MENDER_ARTIFACTS_CI_ARTIFACT_PATH }}

  publish:
    needs: build
    if: ${{ github.event.pull_request.merged }}
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.MENDER_ARTIFACTS_CI_ARTIFACT_NAME }}
          path: ${{ env.MENDER_ARTIFACTS_CI_ARTIFACT_PATH }}
      - name: Upload Mender Artifacts to Server
        uses: 0lmi/mender-push-artifact@main
        with:
          mender_pat: ${{ secrets.MENDER_SERVER_ACCESS_TOKEN }}
          mender_artifact: ${{ env.MENDER_ARTIFACTS_CI_ARTIFACT_PATH }}/${{ needs.build.outputs.mender_artifact_name }}
          mender_uri: ${{ env.MENDER_SERVER_URL }}

  deploy:
    needs: ["build", "publish"]
    if: ${{ github.event.pull_request.merged }}
    runs-on: ubuntu-latest
    steps:
      - name: Create Deployment on Mender Server
        uses: 0lmi/mender-create-deployment@basic_action_implementation
        with:
          mender_pat: ${{ secrets.MENDER_SERVER_ACCESS_TOKEN }}
          mender_uri: ${{ env.MENDER_SERVER_URL }}
          mender_deployment_name: ${{ needs.build.outputs.mender_deployment_name }}
          mender_release_name: ${{ needs.build.outputs.mender_release_name }}
          mender_devices_group: ${{ needs.build.outputs.mender_devices_group }}

